# supervisor.conf (Versión 3.1 - Configuración de Red Robusta)
# Fecha de Actualización: 3 de Septiembre, 2025

[supervisord]
nodaemon=false
logfile=/workspace/logs/supervisord.log
pidfile=/var/run/supervisord.pid

[unix_http_server]
file=/var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[program:worker_server]
# Este servidor ya está configurado correctamente para el proxy. No se necesitan cambios.
command=/usr/bin/python3.11 -m uvicorn worker_server:app --host 0.0.0.0 --port 8188 --proxy-headers
directory=/workspace
environment=HF_HOME="/workspace/huggingface_cache"
autostart=true
autorestart=true
stdout_logfile=/workspace/logs/worker_server.log
stderr_logfile=/workspace/logs/worker_server_errors.log

[program:file_server]
# --- CORRECCIÓN FINAL Y ROBUSTA PARA GUNICORN ---
# --chdir /workspace : Le dice a Gunicorn que cambie a este directorio antes de buscar el archivo 'file_server.py'.
# --forwarded-allow-ips="*" : Le dice a Gunicorn que confíe en las cabeceras del proxy (como X-Forwarded-For) que envía RunPod. Esto es CRÍTICO para que funcione externamente.
command=/usr/bin/python3.11 -m gunicorn --workers 4 --bind 0.0.0.0:8000 --chdir /workspace --forwarded-allow-ips="*" file_server:app
directory=/workspace
autostart=true
autorestart=true
stdout_logfile=/workspace/logs/file_server.log
stderr_logfile=/workspace/logs/file_server_errors.log

[program:comfyui]
# Sin cambios aquí. Este servicio es interno y no necesita configuración de proxy.
command=python main.py --listen 0.0.0.0 --port 8189
directory=/workspace/ComfyUI
autostart=true
autorestart=true
stdout_logfile=/workspace/logs/comfyui.log
stderr_logfile=/workspace/logs/comfyui_errors.log
